# 数値計算法

本節では、非励起減衰近似(NPDA)下におけるSHGおよびcTHGの効率を高速に計算するアルゴリズム、および近似を用いない結合波方程式の一般的な数値解法について述べる。

## 非励起減衰近似下でのSHG出力振幅の$O(N)$計算

非励起減衰近似が成り立つ場合、SHGの出力振幅$A_{2\omega}(L)$は以下の積分で与えられる。

$$
A_{2\omega}(L) = -i A_\omega^2 \int_0^L \kappa_{\text{SHG}}(z) e^{i \Delta k_{\text{SHG}} z} dz
$$

QPMデバイスのような周期的・準周期的構造では、結合係数$\kappa(z)$が区間ごとに定数となるため、この性質を利用することで積分計算を解析的な和の形式に帰着させることができる。
デバイス全体が$N$個のドメインからなり、$n$番目のドメインが区間$[z_{n-1}, z_n]$ (長さ$l_n = z_n - z_{n-1}$) で定義され、その区間内で結合係数が一定値$\kappa_n$を取るとする。このとき、全積分は各ドメインごとの積分の総和として表される。

$$
A_{2\omega}(L) = -i A_\omega^2 \sum_{n=1}^N \kappa_n \int_{z_{n-1}}^{z_n} e^{i \Delta k_{\text{SHG}} z} dz
$$

各区間での積分項$I_n$は解析的に計算できる。

$$
\begin{aligned}
I_n &= \int_{z_{n-1}}^{z_n} e^{i \Delta k_{\text{SHG}} z} dz \\
&= \left[ \frac{e^{i \Delta k_{\text{SHG}} z}}{i \Delta k_{\text{SHG}}} \right]_{z_{n-1}}^{z_n} \\
&= l_n e^{i \Delta k_{\text{SHG}} (z_{n-1} + l_n/2)} \text{sinc}\left(\frac{\Delta k_{\text{SHG}} l_n}{2\pi}\right)
\end{aligned}
$$

ここで$\text{sinc}(x) = \sin(\pi x) / (\pi x)$である。この式を用いることで、数値積分を行うことなく、ドメイン数$N$に比例する計算量$O(N)$で厳密解を得ることができる。

## 非励起減衰近似下でのcTHG出力振幅の$O(N)$計算アルゴリズム

非励起減衰近似下において、cTHGの出力振幅$A_{3\omega}(L)$は、SHG振幅$A_{2\omega}(z)$をソース項とする以下の二重積分で与えられる。

$$
A_{3\omega}(L) = - A_\omega^3 \int_0^L \kappa_{\text{SFG}}(z) e^{i \Delta k_{\text{SFG}} z} \left( \int_0^z \kappa_{\text{SHG}}(z') e^{i \Delta k_{\text{SHG}} z'} dz' \right) dz
$$

単純な数値積分ではドメイン数$N$に対して$O(N^2)$の計算量を要するが、累積和を利用したアルゴリズムを導入することで$O(N)$まで計算量を削減できる。

この式をドメインごとの積分に分解する。外側の積分(SFG過程)の区間を$m$、内側の積分(SHG過程)の区間を$n$とすると、積分範囲$0 \le z' \le z$により、二重積分は「対角項($m=n$)」と「非対角項($n < m$)」に分けられる。

$$
A_{3\omega}(L) = - A_\omega^3 \sum_{m=1}^N \kappa_{\text{SFG}, m} \int_{z_{m-1}}^{z_m} e^{i \Delta k_{\text{SFG}} z} \underbrace{\left( \sum_{n=1}^{m-1} \kappa_{\text{SHG}, n} I_n + \kappa_{\text{SHG}, m} \int_{z_{m-1}}^z e^{i \Delta k_{\text{SHG}} z'} dz' \right)}_{A_{2\omega}(z)} dz
$$

ここで、$I_n$はSHG計算で求めた各区間の積分値である。上式を整理すると、以下の2つの項の和となる。

1.  **対角項 (Diagonal Term)**: ドメイン内でのSHG生成とSFG変換が同時に起こる寄与
    $$
    S_{\text{diag}} = \sum_{m=1}^N \kappa_{\text{SFG}, m} \kappa_{\text{SHG}, m} \int_{z_{m-1}}^{z_m} e^{i \Delta k_{\text{SFG}} z} \left( \int_{z_{m-1}}^z e^{i \Delta k_{\text{SHG}} z'} dz' \right) dz
    $$
2.  **非対角項 (Off-diagonal / History Term)**: 過去のドメインで生成されたSHG光が現在のドメインでSFG変換される寄与
    $$
    S_{\text{off}} = \sum_{m=1}^N \kappa_{\text{SFG}, m} \left( \int_{z_{m-1}}^{z_m} e^{i \Delta k_{\text{SFG}} z} dz \right) \left( \sum_{n=1}^{m-1} \kappa_{\text{SHG}, n} I_n \right)
    $$

### 計算量の削減

単純に実装すると、非対角項の計算において$\sum_{n=1}^{m-1}$の部分が各ステップ$m$で必要となるため、全計算量は$O(N^2)$となる。しかし、SHGの累積振幅を$C_{m-1} = \sum_{n=1}^{m-1} \kappa_{\text{SHG}, n} I_n$と定義すれば、これは漸化式$C_m = C_{m-1} + \kappa_{\text{SHG}, m} I_m$で更新できる。

$$
S_{\text{off}} = \sum_{m=1}^N \kappa_{\text{SFG}, m} J_m C_{m-1}
$$

ここで$J_m = \int_{z_{m-1}}^{z_m} e^{i \Delta k_{\text{SFG}} z} dz$である。$C_{m-1}$は一つ前のステップまでのSHG積分値の総和であり、これはSHG計算の過程で順次求まる値そのものである。

また、対角項の積分についても解析的に解くことができる。
$$
\int_{z_{m-1}}^{z_m} e^{i \Delta k_{\text{SFG}} z} \left( \frac{e^{i \Delta k_{\text{SHG}} z} - e^{i \Delta k_{\text{SHG}} z_{m-1}}}{i \Delta k_{\text{SHG}}} \right) dz
$$
これは指数関数の積分に帰着されるため、閉じた式として導出可能である。

以上により、cTHGの計算においても、累積和変数(Cumulative Sum)を用いることで二重ループを回避し、ドメイン数$N$に対して線形時間$O(N)$での計算が可能となる。

## 結合波方程式の数値解法

ポンプ光の減衰を考慮する必要がある場合など、非励起減衰近似が成立しない条件下では、上記のような解析的簡略化は適用できない。その場合は、常微分方程式(ODE)ソルバを用いて数値解を求める。一般的には、DOP853（8次のDormand-Prince法）等の適応刻み幅ソルバが用いられてきた。

ここで、結合波方程式は位相ミスマッチ$\Delta k$に起因する高速な位相回転項（$e^{i \Delta k z}$）を含んでいることに留意する必要がある。この振動成分は空間的に急速に変化するため、Runge-Kutta法やDOP853といった汎用ソルバを用いる場合、局所誤差（Local error）を許容値以下に抑えるためには、位相回転の周期に合わせて$z$方向に非常に細かくステップを刻む必要がある。
その結果、特にデバイス長が長い場合や$\Delta k$が大きい条件では、数値積分に要するステップ数が膨大となり、計算コストが増大する。
