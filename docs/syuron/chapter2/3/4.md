# 数値計算法

本節では，導出した結合波方程式の数値解法について述べる．まず，ポンプ光の減衰を考慮する必要がある一般的な場合における数値積分手法について触れ，その計算コストの問題点を指摘する．次いで，非励起減衰近似（NPDA）が成立する場合に適用可能な，計算量を $O(N)$ に抑えるアルゴリズムについて，SHGおよびcTHGそれぞれの場合について述べる．

## 結合波方程式の数値解法

ポンプ光の減衰を考慮する必要がある場合など，後述する非励起減衰近似が成立しない条件下では，解析的な取り扱いは困難である．そのため，常微分方程式（ODE）ソルバを用いて結合波方程式の数値解を求める必要がある．一般的には，DOP853（8次のDormand-Prince法）等の適応刻み幅ソルバが用いられる．

ここで，結合波方程式は位相不整合量 $\Delta k$ に起因し，周期 $2\pi/\Delta k$ で変動する位相回転項（$e^{-i \Delta k z}$）を含んでいることに留意する必要がある．この振動成分の空間的な変動周期が短いため，Runge-Kutta法やDOP853といった汎用ソルバを用いる場合，局所誤差（Local error）を許容値以下に抑えるためには，位相回転の周期に対して十分に小さいステップ幅で $z$ 方向に積分を進める必要がある．この制約は，特にデバイス長 $L$ が長い場合や $\Delta k$ が大きい条件において，全ステップ数を増加させ，計算時間の増大を招く．

## 非励起減衰近似下でのSHG出力振幅

変換効率が低く，基本波の枯渇が無視できる場合（非励起減衰近似）には，結合波方程式を解析的に積分することが可能となり，数値積分に要する計算リソースを削減できる．
非励起減衰近似が成り立つ場合，SHGの出力振幅 $A_2(L)$ は以下の積分で与えられる．

$$
A_2(L) = i A_1^2 \int_0^L \kappa_{\text{SHG}}(z) e^{-i \Delta k_{\text{SHG}} z} dz
$$

QPMデバイスのような周期的・準周期的構造では，結合係数 $\kappa(z)$ が区間ごとに定数となる．デバイス全体が $N$ 個のドメインからなり，$n$ 番目のドメインが区間 $[z_{n-1}, z_n]$ （長さ $l_n = z_n - z_{n-1}$）で定義され，その区間内で結合係数が一定値 $\kappa_n$ を取るとすると，全積分は各ドメインごとの積分の総和として表される．

$$
A_2(L) = i A_1^2 \sum_{n=1}^N \kappa_n \int_{z_{n-1}}^{z_n} e^{-i \Delta k_{\text{SHG}} z} dz
$$

各区間での積分項 $I_n$ は以下のように解析的に計算できる．

$$
\begin{aligned}
I_n &= \int_{z_{n-1}}^{z_n} e^{-i \Delta k_{\text{SHG}} z} dz \\
&= \left[ \frac{e^{-i \Delta k_{\text{SHG}} z}}{-i \Delta k_{\text{SHG}}} \right]_{z_{n-1}}^{z_n} \\
&= l_n e^{-i \Delta k_{\text{SHG}} (z_{n-1} + l_n/2)} \text{sinc}\left(\frac{\Delta k_{\text{SHG}} l_n}{2\pi}\right)
\end{aligned}
$$

ここで $\text{sinc}(x) = \sin(\pi x) / (\pi x)$ である．この式を用いることで，汎用ソルバのような周期に依存したステップ刻みの制約を受けず，ドメイン数 $N$ に対して計算量が線形（$O(N)$）に増加する範囲内で厳密解を得ることができる．

## 非励起減衰近似下でのcTHG出力振幅

cTHG過程においても，非励起減衰近似を適用することで，SHGと同様に $O(N)$ の計算量での導出が可能となる．
非励起減衰近似下において，cTHGの出力振幅 $A_3(L)$ は，SHG振幅 $A_2(z)$ をソース項とする以下の二重積分で与えられる．

$$
A_3(L) = -3 A_1^3 \int_0^L \kappa_{\text{SFG}}(z) e^{-i \Delta k_{\text{SFG}} z} \left( \int_0^z \kappa_{\text{SHG}}(z') e^{-i \Delta k_{\text{SHG}} z'} dz' \right) dz
$$

この二重積分を単純な数値積分で計算すると，計算量はドメイン数 $N$ に対して $O(N^2)$ となり，ドメイン数の増加に伴い計算時間が二乗で増大する．しかし，累積和を利用したアルゴリズムを導入することで，SHGと同様の $O(N)$ まで計算量を低減できる．

上式をドメインごとの積分に分解する．外側の積分（SFG過程）の区間を $m$，内側の積分（SHG過程）の区間を $n$ とすると，積分範囲 $0 \le z' \le z$ により，二重積分は「対角項（$m=n$）」と「非対角項（$n < m$）」に分けられる．

$$
A_3(L) = -3 A_1^3 \sum_{m=1}^N \kappa_{\text{SFG}, m} \int_{z_{m-1}}^{z_m} e^{-i \Delta k_{\text{SFG}} z} \underbrace{\left( \sum_{n=1}^{m-1} \kappa_{\text{SHG}, n} I_n + \kappa_{\text{SHG}, m} \int_{z_{m-1}}^z e^{-i \Delta k_{\text{SHG}} z'} dz' \right)}_{\propto A_2(z)} dz
$$

ここで，$I_n$ はSHG計算で求めた各区間の積分値である．上式を整理すると，以下の2つの項の和となる．

1.  **対角項 (Diagonal Term)**: ドメイン内でのSHG生成とSFG変換が同時に起こる寄与
    $$
    S_{\text{diag}} = \sum_{m=1}^N \kappa_{\text{SFG}, m} \kappa_{\text{SHG}, m} \int_{z_{m-1}}^{z_m} e^{-i \Delta k_{\text{SFG}} z} \left( \int_{z_{m-1}}^z e^{-i \Delta k_{\text{SHG}} z'} dz' \right) dz
    $$
2.  **非対角項 (Off-diagonal / History Term)**: 過去のドメインで生成されたSHG光が現在のドメインでSFG変換される寄与
    $$
    S_{\text{off}} = \sum_{m=1}^N \kappa_{\text{SFG}, m} \left( \int_{z_{m-1}}^{z_m} e^{-i \Delta k_{\text{SFG}} z} dz \right) \left( \sum_{n=1}^{m-1} \kappa_{\text{SHG}, n} I_n \right)
    $$

### 計算量の削減手法

非対角項の計算において，総和 $\sum_{n=1}^{m-1}$ の計算を各ステップ $m$ で毎回行うと全計算量は $O(N^2)$ となる．しかし，SHGの累積振幅を $C_{m-1} = \sum_{n=1}^{m-1} \kappa_{\text{SHG}, n} I_n$ と定義すれば，これは漸化式 $C_m = C_{m-1} + \kappa_{\text{SHG}, m} I_m$ で更新できる．これにより，非対角項は以下のように計算できる．

$$
S_{\text{off}} = \sum_{m=1}^N \kappa_{\text{SFG}, m} J_m C_{m-1}
$$

ここで $J_m = \int_{z_{m-1}}^{z_m} e^{-i \Delta k_{\text{SFG}} z} dz$ である．$C_{m-1}$ は一つ前のステップまでのSHG積分値の総和であり，これはSHG計算の過程で順次求まる値そのものである．

また，対角項の積分についても，指数関数の積分として以下のように解析的に閉じた式で導出可能である．

$$
\int_{z_{m-1}}^{z_m} e^{-i \Delta k_{\text{SFG}} z} \left( \frac{e^{-i \Delta k_{\text{SHG}} z} - e^{-i \Delta k_{\text{SHG}} z_{m-1}}}{-i \Delta k_{\text{SHG}}} \right) dz
$$

以上により，cTHGの計算においても，累積和変数（Cumulative Sum）を用いることで二重ループを回避し，ドメイン数 $N$ に対して線形時間 $O(N)$ での計算が可能となる．ドメイン数に対して計算量が線形に増加する特性は，数万から数百万ドメインを有する大規模なQPMデバイスの解析・最適化において，実用上の優位性を持つ．
