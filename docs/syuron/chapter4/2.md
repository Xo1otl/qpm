# 結合波方程式の相互作用描像における一次摂動

本節では、cTHGを含む結合波方程式の数値解法として、相互作用描像における一次摂動を用いた新しい状態予測子について述べる。
この手法は、従来のRK法などの汎用的な常微分方程式解法とは異なり、結合波方程式特有の構造を利用することで、計算速度と精度を劇的に向上させるものである。

<!-- 結合波方程式 -->

前節で示した通り、cTHGを記述する結合波方程式は以下のように与えられる。

$$
\frac{d A_1}{dz} = i \left[ \kappa_{\text{SHG}} A_2 A_1^* e^{i\Delta k_{\text{SHG}} z} + \kappa_{\text{SFG}} A_3 A_2^* e^{i\Delta k_{\text{SFG}} z} \right]
$$

$$
\frac{d A_2}{dz} = i \left[ \kappa_{\text{SHG}} A_1^2 e^{-i\Delta k_{\text{SHG}} z} + 2 \kappa_{\text{SFG}} A_3 A_1^* e^{i\Delta k_{\text{SFG}} z} \right]
$$

$$
\frac{d A_3}{dz} = i \left[ 3 \kappa_{\text{SFG}} A_1 A_2 e^{-i\Delta k_{\text{SFG}} z} \right]
$$

ここで、$A_1, A_2, A_3$ はそれぞれ基本波、第二高調波、第三高調波の複素振幅、$\Delta k_{\text{SHG}}, \Delta k_{\text{SFG}}$ は位相不整合量、$\kappa_{\text{SHG}}(z), \kappa_{\text{SFG}}(z)$ はSHGとSFGの結合係数である。

<!-- ハミルトニアン形式 -->

この方程式系は、相互作用描像（回転座標系）への変換 $\boldsymbol{B}(z) = e^{i\boldsymbol{L}z} \boldsymbol{A}(z)$ を導入することで、より見通しよく記述できる。ここで、行列 $\boldsymbol{L}$ は以下のように定義される。

$$
\boldsymbol{L} = \begin{pmatrix} 0 & 0 & 0 \\ 0 & \Delta k_{\text{SHG}} & 0 \\ 0 & 0 & \Delta k_{\text{SHG}} + \Delta k_{\text{SFG}} \end{pmatrix}
$$

変換後の振幅ベクトル $\boldsymbol{B}$ に対して運動方程式をハミルトニアン形式で記述すると以下のようになる。

$$
\dot{\boldsymbol{B}} = i \boldsymbol{J} \nabla_{\boldsymbol{B}^*} (K_{\text{LIN}} + K_{\text{NL}})
$$

ここで、$\boldsymbol{J} = \text{diag}(1, 2, 3)$ であり、ハミルトニアンの線形部分 $K_{\text{LIN}}$ と非線形部分 $K_{\text{NL}}$ はそれぞれ次のように与えられる。

$$
K_{\text{NL}} = \frac{\kappa_{\text{SHG}}}{2} \left( B_1^2 B_2^* + c.c. \right) + \kappa_{\text{SFG}} \left( B_1 B_2 B_3^* + c.c. \right)
$$

$$
K_{\text{LIN}} = \frac{\Delta k_{\text{SHG}}}{2} |B_2|^2 + \frac{\Delta k_{\text{SHG}} + \Delta k_{\text{SFG}}}{3} |B_3|^2
$$

これにより、位相不整合項が線形ポテンシャルとして取り込まれ、非線形相互作用項が明確に分離される。

## 積分形と一次摂動

微分方程式を積分形（Volterra積分方程式）に書き改めると、ステップサイズ $h$ 後の状態 $\boldsymbol{B}(z_n+h)$ は以下のように表される。

$$
\boldsymbol{B}(z_n+h) = e^{i\boldsymbol{L}h} \boldsymbol{B}(z_n) + i \int_0^h e^{i\boldsymbol{L}(h-\tau')} \boldsymbol{N}(\boldsymbol{B}(z_n+\tau'), \boldsymbol{B}^*(z_n+\tau')) d\tau'
$$

ここで、非線形項ベクトル $\boldsymbol{N}$ は以下の要素を持つ。

$$
\boldsymbol{N}=\begin{pmatrix} \kappa_{\text{SHG}}B_1^\ast B_2+\kappa_{\text{SFG}}B_2^\ast B_3 \\ \kappa_{\text{SHG}}B_1^2+2\kappa_{\text{SFG}}B_1^\ast B_3 \\ 3\kappa_{\text{SFG}}B_1B_2 \\ \end{pmatrix}
$$

相互作用描像を用いた一次摂動近似として、積分内の $\boldsymbol{B}(z_n+\tau')$ を線形発展のみで近似した $\boldsymbol{B}^{(0)}(z_n + \tau') = e^{i\boldsymbol{L}\tau'}\boldsymbol{B}(z_n)$ に置き換える。これは、微小ステップ内では非線形相互作用による振幅変化が位相回転に比べて緩やかであると仮定することに相当する。

## 状態予測式

近似を適用して積分を実行することで、次のステップの予測値 $\boldsymbol{B}_{\text{pred}}$ を解析的に得ることができる。

$$
\boldsymbol{B}_{\text{pred}} = e^{i\boldsymbol{L}h_n} \boldsymbol{B}_n + \boldsymbol{B}_{\text{NL}}
$$

ここで、非線形寄与項 $\boldsymbol{B}_{\text{NL}}$ は、関数 $\phi(\omega, h) = \frac{e^{i\omega h} - 1}{i\omega}$ を用いて次のように書き下せる。

$$
\boldsymbol{B}_{\text{NL}} = i e^{i\boldsymbol{L}h_n} \begin{pmatrix} \kappa_{\text{SHG}} B_{1n}^* B_{2n} \phi(\Delta k_{\text{SHG}}, h_n) + \kappa_{\text{SFG}} B_{2n}^* B_{3n} \phi(\Delta k_{\text{SFG}}, h_n) \\ \kappa_{\text{SHG}} B_{1n}^2 \phi(-\Delta k_{\text{SHG}}, h_n) + 2 \kappa_{\text{SFG}} B_{1n}^* B_{3n} \phi(\Delta k_{\text{SFG}}, h_n) \\ 3 \kappa_{\text{SFG}} B_{1n} B_{2n} \phi(-\Delta k_{\text{SFG}}, h_n) \\ \end{pmatrix}
$$

この予測式は、ステップ内の結合係数 $\kappa$ が一定の範囲（1ドメイン内など）で有効である。
したがって、従来のRK法やDOP853のように高速な位相回転を追跡するために極めて微小なステップ幅をとる必要がなく、ドメイン単位での粗いステップ更新が可能である。

## ポリドメイン解析積分（Super Step）

さらに、計算を加速させるために、個々のドメインごとではなく、複数のドメインをまとめて1つの「Super Step」として扱う手法を導入した。
$M$ 個のドメインを結合し、ブロック長 $H = \sum_{j=0}^{M-1} h_j$ とする。
ドメインごとの符号反転 $s_n$ を考慮し、構造因子（Structure Factor） $\Psi(\omega)$ を以下のように定義する。

$$
\Psi(\omega) = \sum_{j=0}^{M-1} s_j e^{i\omega Z_j} \phi(\omega, h_j)
$$

ここで、$Z_0 = 0, Z_j = \sum_{k=0}^{j-1} h_k$ である。
これを用いると、ブロック全体の更新式は以下のように記述できる。

$$
\boldsymbol{B}(z_0 + H) \approx e^{i\boldsymbol{L}H} \boldsymbol{B}(z_0) + \boldsymbol{B}_{\text{NL}}^{\text{block}}
$$

$$
\boldsymbol{B}_{\text{NL}}^{\text{block}} = i e^{i\boldsymbol{L}H} \begin{pmatrix}|\kappa_{\text{SHG}}| B_{1}^* B_{2} \Psi(\Delta k_{\text{SHG}}) + |\kappa_{\text{SFG}}| B_{2}^* B_{3} \Psi(\Delta k_{\text{SFG}}) \\ |\kappa_{\text{SHG}}| B_{1}^2 \Psi(-\Delta k_{\text{SHG}}) + 2 |\kappa_{\text{SFG}}| B_{1}^* B_{3} \Psi(\Delta k_{\text{SFG}}) \\ 3 |\kappa_{\text{SFG}}| B_{1} B_{2} \Psi(-\Delta k_{\text{SFG}}) \\ \end{pmatrix}_{\boldsymbol{B}=\boldsymbol{B}_0}
$$

この手法により、ドメイン単位のループ計算を回避し、積分カーネルを事前に計算しておくことで、さらに高速なシミュレーションが可能となる。また、本手法はUPAを前提としていない。
